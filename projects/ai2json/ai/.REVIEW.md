$lang: 中文
---------- Reviewed by: claude

projects/ai2json/ai/.REVIEW.md
    ├── codex.py
    └── claude.py

# Overview:
该项目实现了一个 AI-to-JSON 适配器层，包含 Claude CLI 和 GPT-5 Codex CLI 两个具体实现。两个模块均继承 ThisAI2JSON 基类，负责定位可执行入口、构造命令行参数、解析 JSON 输出流。代码整体成熟，具备跨平台兼容性和健壮的错误处理机制，当前状态可直接投入生产使用。

# Review:
**文档与代码质量**：两个模块均具备清晰的类型标注和逻辑分层，代码可读性高。缺少独立的 README、架构文档和使用示例，但模块内注释充分且评审记录详实。

**实现状态**：完成度约 100%。Claude 模块实现了 root/非 root 环境的权限策略适配（root 下使用 acceptEdits 模式，非 root 下跳过权限检查）；Codex 模块实现了新旧两种 JSON 事件流格式的兼容解析。两者均采用三级入口定位回退策略（node + js 脚本 → 命令 → 裸字符串），保证跨环境可用性。

**可测试性**：良好。建议覆盖以下场景：（1）CLI 输出的正常、空、格式错误等各种形态；（2）root/非 root 两种权限模式；（3）新旧 JSON 格式共存的边缘情况；（4）入口文件缺失、无执行权限或损坏的异常路径。

**风险与优先级**：无阻塞性缺陷。主要风险来自入口定位时仅检查文件存在性，未处理权限或损坏等极端情况，可能在运行时抛出不明确的错误；Codex 模块假设单次调用仅返回单一格式事件，若新旧格式共存可能只解析首个匹配项。建议优先在 ai2json.py 基类的 exec 方法中增强异常捕获和提示友好度，次要优化文档完整性。

# Notes:
- 两个模块均使用三级入口定位回退策略（node + js 脚本 → 命令 → 裸字符串），与跨平台部署需求保持一致
- Claude 模块针对 Linux/macOS root 环境的特殊限制进行适配：root 下 --dangerously-skip-permissions 被禁止，改用 --permission-mode acceptEdits 自动授权工作目录及子目录的读写与 Bash 执行
- Codex 模块同时支持新格式 {type:item.completed, item:{type:agent_message, text:...}} 和旧格式 {msg:{type:agent_message, message:...}}，兼容性设计具备前瞻性
- Codex 的 _extract_json 先尝试直接 json.loads，失败后回退至父类围栏提取逻辑，兼顾性能与兼容性
- 两个模块均使用绕过审批或权限检查的参数（如 --dangerously-bypass-approvals-and-sandbox、--skip-git-repo-check），适用于自动化场景但需明确安全边界
- Claude 模块使用 --append-system-prompt 注入系统提示，避免与用户提示拼接导致的语义混淆

# Imperfections:
- 入口定位逻辑中 candidate.exists() 仅检查文件存在性，未处理无执行权限或文件损坏的极端情况，可能在后续 subprocess.run 时失败并抛出不够明确的错误；建议在 ai2json.py 的 exec 方法中捕获 FileNotFoundError 或 PermissionError 并给出更友好提示（claude.py 和 codex.py 均存在此问题）
- Codex 模块的 _parse_stdout 中两种格式检查存在顺序依赖：先检查新格式再检查旧格式；若未来新旧格式共存于同一事件流的不同事件中，可能导致只取到第一个匹配的格式而忽略后续；当前实现假设每次调用只返回一种格式的单一目标事件，该假设应记录在文档中
- Claude 模块的 is_root 检查使用 hasattr(os, 'getuid') 作为回退，在某些罕见的 Unix-like 系统上可能存在 getuid 存在但行为异常的情况，当前实现假设 getuid() 不抛出异常
